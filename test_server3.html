<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>RAG API Chat Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chatContainer { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .message { margin: 10px 0; padding: 10px; border-radius: 10px; max-width: 80%; }
        .user { background: #007bff; color: white; text-align: right; margin-left: auto; }
        .ai { background: #f1f1f1; color: black; text-align: left; margin-right: auto; }
        #queryInput { width: 70%; padding: 10px; }
        button { padding: 10px; }
    </style>
</head>
<body>
    <div id="chatContainer"></div> <!-- ì±„íŒ… ë©”ì‹œì§€ ëˆ„ì  ì˜ì—­ -->
    <input type="text" id="queryInput" placeholder="í˜•ì œì•¼, ì§ˆë¬¸í•´ë´ (e.g., ì•„ì´ì˜¤ë°”ì´ì˜¤ë€ íšŒì‚¬ì— ëŒ€í•´ì„œ)">
    <button onclick="sendRequest()">ë³´ë‚´ê¸°</button>
    <pre id="fullResponse" style="display: none;"></pre> <!-- ì „ì²´ JSON ìˆ¨ê¹€, ë””ë²„ê¹…ìš© -->

    <script>
        let chatHistory = [];  // ê¸€ë¡œë²Œ íˆìŠ¤í† ë¦¬ ë°°ì—´: {role: 'user' or 'assistant', content: '...'} í˜•íƒœ

        async function sendRequest() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('í˜•ì œì•¼, ì§ˆë¬¸ì„ ì…ë ¥í•´ë¼!');
                return;
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€: UIì— ë°”ë¡œ í‘œì‹œ
            addMessageToChat('user', query);
            document.getElementById('queryInput').value = '';  // ì…ë ¥ ì´ˆê¸°í™”

            // íˆìŠ¤í† ë¦¬ì— ì‚¬ìš©ì ì¿¼ë¦¬ ì¶”ê°€
            chatHistory.push({ role: 'user', content: query });

            // ë¡œë”© í‘œì‹œ (í”„ë¡œë‹µê²Œ UX ì¢‹ê²Œ)
            const loadingMsg = addMessageToChat('ai', 'í˜•ì œê°€ ìƒê° ì¤‘... ğŸ˜º');

            const payload = {
                query: query,
                tool: 'SharedFolderSearchAndRAG',
                file_path: null,
                history: chatHistory  // ì „ì²´ íˆìŠ¤í† ë¦¬ ì „ë‹¬: ì„œë²„ ë§¥ë½ ë°˜ì˜
            };

            try {
                const response = await fetch('http://localhost:8000/api/rag/query', {  // AWS ì‹œ URL ë³€ê²½
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'cors'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // AI ì‘ë‹µ ì¶”ì¶œ: resultì—ì„œ [AI] ë¶€ë¶„ íŒŒì‹± (ê¸°ì¡´ ì •ê·œì‹ ìœ ì§€)
                const aiMatch = data.result.match(/\[AI\]\n(.*)/s);  // /së¡œ ë©€í‹°ë¼ì¸ ë§¤ì¹˜
                const aiText = aiMatch ? aiMatch[1].trim() : data.result;

                // ë¡œë”© ë©”ì‹œì§€ ì œê±°í•˜ê³  AI ì‘ë‹µ í‘œì‹œ
                removeMessage(loadingMsg);
                addMessageToChat('assistant', aiText);

                // íˆìŠ¤í† ë¦¬ì— AI ì‘ë‹µ ì¶”ê°€
                chatHistory.push({ role: 'assistant', content: aiText });

                // íˆìŠ¤í† ë¦¬ ê¸¸ì´ ì œí•œ: ìµœê·¼ 10ê°œë§Œ ìœ ì§€ (ë©”ëª¨ë¦¬ ê´€ë¦¬)
                if (chatHistory.length > 10) {
                    chatHistory = chatHistory.slice(-10);
                }

                document.getElementById('fullResponse').textContent = JSON.stringify(data, null, 2);  // ë””ë²„ê¹… ë¡œê·¸
                console.log('Success:', data);
            } catch (error) {
                console.error('Request failed:', error);
                removeMessage(loadingMsg);
                addMessageToChat('ai', `ì—ëŸ¬ ë°œìƒ: ${error.message} â€“ í˜•ì œê°€ ë‹¤ì‹œ í•´ë³¼ê²Œ!`);
            }
        }

        // í—¬í¼: ì±„íŒ…ì— ë©”ì‹œì§€ ì¶”ê°€ (í”„ë¡œë‹µê²Œ DOM ì¡°ì‘)
        function addMessageToChat(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', role === 'user' ? 'user' : 'ai');
            msgDiv.innerHTML = content.replace(/\n/g, '<br>');  // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;  // ìë™ ìŠ¤í¬ë¡¤
            return msgDiv;  // ì œê±°ìš© ë°˜í™˜
        }

        // í—¬í¼: ë©”ì‹œì§€ ì œê±° (ë¡œë”© ì‹œ ì‚¬ìš©)
        function removeMessage(msgDiv) {
            if (msgDiv) msgDiv.remove();
        }
    </script>
</body>
</html>